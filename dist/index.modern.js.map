{"version":3,"file":"index.modern.js","sources":["../src/constants.ts","../src/objects/DOMElement.ts","../src/renderers/DOMContext.ts"],"sourcesContent":["/**\n * Useful for projecting to scale high-resolution DOM elements\n */\nexport const cssFactor = 100;\n","import {\n  Mesh,\n  PlaneGeometry,\n  MeshBasicMaterial,\n  NoBlending,\n  DoubleSide,\n  Vector3,\n  Box3,\n} from 'three';\nimport { CSS3DObject } from 'three/examples/jsm/renderers/CSS3DRenderer';\nimport { DOMContext } from '../renderers/DOMContext';\nimport { cssFactor } from '../constants';\n\nexport class DOMElement extends Mesh {\n  /**\n   * The active `DOMContext` to draw on\n   */\n  context: DOMContext;\n  /**\n   * The projected 2D DOM element\n   */\n  domElement: HTMLElement;\n  /**\n   * DOM element aspect artio\n   */\n  aspectRatio: number;\n  /**\n   * DOM element width\n   */\n  elementWidth: number;\n  /**\n   * DOM element height\n   */\n  elementHeight: number;\n  /**\n   * 3D projection width\n   */\n  width: number;\n  /**\n   * 3D projection height\n   */\n  height: number;\n  /**\n   * The projecting 3D object\n   */\n  cssObject: CSS3DObject;\n  /**\n   * Internal `Vector3` for WebGL size/scale calculations\n   */\n  size: Vector3;\n  /**\n   * Internal `Box` used for bounding box calculations\n   */\n  box: Box3;\n\n  /**\n   * DOM element that is projected into 3D space\n   * @param context A DOM context instance to draw on\n   * @param domElement A DOM element to project\n   * @param options DOM element options\n   * @param options.elementWidth DOM element width\n   * @param options.width 3D plane width\n   * @param options.height 3D plane height\n   */\n  constructor(\n    context: DOMContext,\n    domElement: HTMLElement,\n    { elementWidth = 768, width = 1, height = 0.75 } = {}\n  ) {\n    // Create portal mesh\n    const geometry = new PlaneGeometry(width, height);\n    const material = new MeshBasicMaterial({\n      opacity: 0,\n      blending: NoBlending,\n      side: DoubleSide,\n    });\n    super(geometry, material);\n\n    // Expose params\n    this.context = context;\n    this.domElement = domElement;\n    this.aspectRatio = height / width;\n    this.elementWidth = elementWidth;\n    this.elementHeight = this.elementWidth * this.aspectRatio;\n    this.width = width;\n    this.height = height;\n\n    // Set initial size\n    this.resizeElement();\n\n    // Init 3D DOM\n    this.cssObject = new CSS3DObject(this.domElement);\n    this.cssObject.scale.multiplyScalar(cssFactor / (this.elementWidth / this.width));\n\n    // Init helpers\n    this.size = new Vector3();\n    this.box = new Box3();\n\n    // Init events\n    this.addEventListener('added', this.handleAdded);\n    this.addEventListener('removed', this.handleRemoved);\n\n    // Bind update\n    this.update = this.update.bind(this);\n  }\n\n  /**\n   * Adds the current cssObject to the scene\n   */\n  handleAdded() {\n    this.context.cssScene.add(this.cssObject);\n  }\n\n  /**\n   * Removes the current cssObject from the scene\n   */\n  handleRemoved() {\n    this.context.cssScene.remove(this.cssObject);\n  }\n\n  /**\n   * Resizes DOM element to sync with projection\n   */\n  resizeElement() {\n    this.domElement.style.width = `${this.elementWidth}px`;\n    this.domElement.style.height = `${this.elementHeight}px`;\n  }\n\n  /**\n   * Updates the projected DOM element\n   * @param domElement A DOM element to project\n   */\n  setElement(domElement: HTMLElement) {\n    // Cleanup previous element\n    if (this.domElement.parentNode) {\n      this.domElement.parentNode.removeChild(this.domElement);\n    }\n\n    // Set new element\n    this.domElement = domElement;\n    this.cssObject.element = domElement;\n\n    // Reset element size\n    this.resizeElement();\n  }\n\n  /**\n   * Updates the DOM element and its projection states\n   */\n  update() {\n    // Get global transform\n    this.updateMatrixWorld();\n    const worldMatrix = this.matrixWorld;\n    worldMatrix.decompose(this.position, this.quaternion, this.scale);\n\n    // Sync CSS properties with WebGL mesh\n    this.cssObject.quaternion.copy(this.quaternion);\n    this.cssObject.position.copy(this.position).multiplyScalar(cssFactor);\n\n    // Calculate CSS scale factor\n    this.box.setFromObject(this).getSize(this.size);\n    const scaleFactor = this.elementWidth / (this.size.x * this.scale.x);\n\n    // Sync CSS scale with WebGL projection\n    this.cssObject.scale.multiplyScalar(cssFactor / scaleFactor);\n    this.cssObject.visible = this.visible;\n  }\n\n  /**\n   * Disposes WebGL and DOM elements\n   */\n  dispose() {\n    // Cleanup events\n    this.removeEventListener('added', this.handleAdded);\n    this.removeEventListener('removed', this.handleRemoved);\n\n    // Cleanup DOM\n    this.domElement.remove();\n\n    // Cleanup WebGL\n    this.geometry.dispose();\n    (this.material as MeshBasicMaterial).dispose();\n  }\n}\n","import { PerspectiveCamera, Scene } from 'three';\nimport { CSS3DRenderer } from 'three/examples/jsm/renderers/CSS3DRenderer';\nimport { DOMElement } from '../objects/DOMElement';\nimport { cssFactor } from '../constants';\n\nexport class DOMContext {\n  /**\n   * Whether to enable the `DOMContext` and its projection. Default is `true.`\n   */\n  enabled: boolean;\n  /**\n   * Renderer used for rendering the DOM\n   */\n  cssRenderer: CSS3DRenderer;\n  /**\n   * Target DOM element to render to\n   */\n  domElement: HTMLElement;\n  /**\n   * Camera used for CSS projection\n   */\n  cssCamera: PerspectiveCamera;\n  /**\n   * Parent camera used to sync with WebGL\n   */\n  camera: PerspectiveCamera;\n  /**\n   * CSS scene used to contain CSS projections\n   */\n  cssScene: Scene;\n\n  /**\n   * DOM context instance\n   * @param camera  A perspective camera instance to draw from\n   */\n  constructor(camera: PerspectiveCamera) {\n    // Set default settings\n    this.enabled = true;\n\n    // Init renderer\n    this.cssRenderer = new CSS3DRenderer();\n    this.domElement = this.cssRenderer.domElement;\n\n    // Init camera\n    this.cssCamera = new PerspectiveCamera(\n      camera.fov,\n      camera.aspect,\n      camera.near * cssFactor,\n      camera.far * cssFactor\n    );\n    this.camera = camera;\n\n    // Init scene\n    this.cssScene = new Scene();\n\n    // Bind update\n    this.update = this.update.bind(this);\n  }\n\n  /**\n   * Resizes the DOM context's renderer and camera\n   * @param width Target width\n   * @param height Target height\n   */\n  setSize(width: number, height: number) {\n    this.cssRenderer.setSize(width, height);\n    this.cssCamera.aspect = width / height;\n    this.cssCamera.updateProjectionMatrix();\n  }\n\n  /**\n   * Updates the DOM context's renderer and camera states\n   */\n  update() {\n    // Sync CSS camera with WebGL camera\n    this.cssCamera.quaternion.copy(this.camera.quaternion);\n    this.cssCamera.position.copy(this.camera.position).multiplyScalar(cssFactor);\n\n    // Update descendants\n    if (this.enabled) {\n      this.cssScene.traverse(child => {\n        const element = child as DOMElement;\n\n        if (!element.update) return;\n\n        element.update();\n      });\n    }\n\n    // Render projection\n    this.cssRenderer.render(this.cssScene, this.cssCamera);\n  }\n}\n"],"names":["cssFactor","DOMElement","Mesh","constructor","context","domElement","elementWidth","width","height","super","PlaneGeometry","MeshBasicMaterial","opacity","blending","NoBlending","side","DoubleSide","this","aspectRatio","elementHeight","resizeElement","cssObject","CSS3DObject","scale","multiplyScalar","size","Vector3","box","Box3","addEventListener","handleAdded","handleRemoved","update","bind","cssScene","add","remove","style","setElement","parentNode","removeChild","element","updateMatrixWorld","matrixWorld","decompose","position","quaternion","copy","setFromObject","getSize","x","visible","dispose","removeEventListener","geometry","material","DOMContext","camera","enabled","cssRenderer","CSS3DRenderer","cssCamera","PerspectiveCamera","fov","aspect","near","far","Scene","setSize","updateProjectionMatrix","traverse","child","render"],"mappings":"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"}